// Prisma Schema for NodeCG Next
// Based on architecture design from documentation

generator client {
  provider = "prisma-client-js"
  output   = "../src/database/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Replicant storage
model Replicant {
  id        String   @id @default(cuid())
  namespace String
  name      String
  value     String // JSON serialized
  schema    String? // JSON Schema
  revision  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  history   ReplicantHistory[]

  @@unique([namespace, name])
  @@index([namespace])
  @@map("replicants")
}

model ReplicantHistory {
  id          String    @id @default(cuid())
  replicantId String
  replicant   Replicant @relation(fields: [replicantId], references: [id], onDelete: Cascade)
  value       String // JSON serialized
  revision    Int
  changedBy   String?
  changedAt   DateTime  @default(now())

  @@index([replicantId])
  @@index([changedAt])
  @@map("replicant_history")
}

// User management
model User {
  id        String          @id @default(cuid())
  username  String          @unique
  email     String?         @unique
  password  String? // bcrypt hashed (null for OAuth-only users)
  roleId    String? // Foreign key to Role
  role      Role?           @relation(fields: [roleId], references: [id])
  providers OAuthProvider[]
  sessions  Session[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([username])
  @@index([email])
  @@index([roleId])
  @@map("users")
}

// RBAC Role model
model Role {
  id          String           @id @default(cuid())
  name        String           @unique // "admin", "operator", "viewer"
  displayName String // "Administrator", "Operator", "Viewer"
  description String?
  permissions RolePermission[]
  users       User[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([name])
  @@map("roles")
}

// RBAC Permission model
model Permission {
  id          String           @id @default(cuid())
  name        String           @unique // "replicant:read", "replicant:write", "bundle:manage"
  resource    String // "replicant", "bundle", "user", "asset"
  action      String // "read", "write", "delete", "manage"
  description String?
  roles       RolePermission[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([resource])
  @@index([action])
  @@map("permissions")
}

// Join table for many-to-many relationship between Role and Permission
model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model OAuthProvider {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider     String // "twitch", "discord", "google", "github"
  providerId   String // Provider's user ID
  accessToken  String? // Encrypted
  refreshToken String? // Encrypted
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_providers")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique // JWT token
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Asset management
model Asset {
  id        String   @id @default(cuid())
  namespace String // Bundle namespace
  category  String // Asset category (e.g., "images", "sounds")
  name      String // Filename
  sum       String // MD5 checksum
  url       String // S3/MinIO URL
  size      Int // File size in bytes
  mimeType  String // MIME type
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([namespace, category, name])
  @@index([namespace, category])
  @@map("assets")
}

// Bundle management
model Bundle {
  id        String   @id @default(cuid())
  name      String   @unique
  version   String
  config    String // JSON serialized bundle config
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([enabled])
  @@map("bundles")
}

// Audit logging
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String // "replicant:update", "bundle:load", etc.
  resource  String // Resource identifier
  metadata  String? // JSON serialized additional data
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
